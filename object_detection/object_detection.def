Bootstrap: library
From: ubuntu:18.04
Stage: build

%files
    ../../Miniconda3-latest-Linux-x86_64.sh /opt
    ../../cuda_10.2.89_440.33.01_linux.run /opt

%environment
    export PATH=/opt/miniconda3/bin:$PATH
    #export PYTHONPATH=/opt/training/object_detection/pytorch/maskrcnn_benchmark:${PYTHONPATH}
    export PATH=/usr/local/cuda-10.2/bin:/usr/local/cuda-10.2/nsight-compute-2019.5.0${PATH:+:${PATH}}
    export LD_LIBRARY_PATH=/usr/local/cuda-10.2/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}

%post
    apt-get update && apt-get upgrade
    apt-get install -y curl emacs g++ gcc git unzip

    # conda
    cd /opt
    bash ./Miniconda3-latest-Linux-x86_64.sh -b -p /opt/miniconda3
    export PATH=/opt/miniconda3/bin:$PATH
    conda update conda
    conda install -y pytorch==1.3.1 pip==19.3.1
    pip install \
        cython==0.29.14 \
        matplotlib==3.1.2 \
        mlperf_compliance==0.0.10 \
        opencv-python==4.1.2.30 \
        torchvision==0.2.1 \
        tqdm==4.40.2 \
        yacs==0.1.6

    # cocodataset
    git clone https://github.com/cocodataset/cocoapi.git \
        && cd cocoapi/PythonAPI \
        && git reset --hard ed842bffd41f6ff38707c4f0968d2cfd91088688 \
        && python setup.py build_ext install

    # cuda
    cd /opt
    bash ./cuda_10.2.89_440.33.01_linux.run --silent --toolkit
    export PATH=/usr/local/cuda-10.2/bin:/usr/local/cuda-10.2/nsight-compute-2019.5.0${PATH:+:${PATH}}
    export LD_LIBRARY_PATH=/usr/local/cuda-10.2/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}

    # cuda available?
    python -c "import torch;from torch.utils.cpp_extension import CUDA_HOME;print(CUDA_HOME);print(torch.cuda.is_available())"

    # mlperf training
    cd /opt
    git clone --recursive https://github.com/wohlbier/training.git
    cd training/object_detection
    bash ./install.sh
    # done at location code is run.
    #bash ./download_dataset.sh

%runscript
    echo "Container was created $NOW"
    echo "Arguments received: $*"
    exec echo "$@"

%help
    Container for mlperf object_detection.
    Create:
    sudo singularity build object_detection.sif object_detection.def
    or
    sudo singularity build --sandbox object_detection object_detection.def
    sudo singularity build object_detection.sif object_detection

    Run interactively:
    singularity shell --bind /pylon5/cc5phsp/wohlbier/training/object_detection/pytorch/datasets/coco:/opt/training/object_detection/pytorch/datasets/coco  --nv object_detection.sif
